package resolver

// This file will be automatically regenerated based on the schema, any resolver
// implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.85

import (
	"context"
	"fmt"

	"github.com/xzzpig/rclone-sync/internal/api/graphql/generated"
	"github.com/xzzpig/rclone-sync/internal/api/graphql/model"
	"github.com/xzzpig/rclone-sync/internal/rclone"
)

// List is the resolver for the list field.
func (r *providerQueryResolver) List(ctx context.Context, obj *model.ProviderQuery) ([]*model.Provider, error) {
	providers := rclone.ListProviders()
	result := make([]*model.Provider, 0, len(providers))
	for _, p := range providers {
		result = append(result, &model.Provider{
			Name:        p.Name,
			Description: p.Description,
			Prefix:      p.Name, // rclone uses name as prefix
			Options:     nil,    // Options are loaded lazily via get query
		})
	}
	return result, nil
}

// Get is the resolver for the get field.
func (r *providerQueryResolver) Get(ctx context.Context, obj *model.ProviderQuery, name string) (*model.Provider, error) {
	// Return nil for empty name
	if name == "" {
		return nil, nil
	}

	provider, err := rclone.GetProviderOptions(name)
	if err != nil {
		// Return nil instead of error for not found providers
		// This matches GraphQL convention for nullable single-item queries
		return nil, nil
	}

	options := make([]*model.ProviderOption, 0, len(provider.Options))
	for _, opt := range provider.Options {
		// Convert default value to string pointer
		var defaultVal *string
		if opt.Default != nil {
			s := fmt.Sprintf("%v", opt.Default)
			if s != "" {
				defaultVal = &s
			}
		}

		// Convert examples
		var examples []*model.OptionExample
		if len(opt.Examples) > 0 {
			examples = make([]*model.OptionExample, 0, len(opt.Examples))
			for _, ex := range opt.Examples {
				help := ex.Help
				var helpPtr *string
				if help != "" {
					helpPtr = &help
				}
				examples = append(examples, &model.OptionExample{
					Value: ex.Value,
					Help:  helpPtr,
				})
			}
		}

		// Convert groups to string pointer
		var groupsPtr *string
		if opt.Groups != "" {
			groupsPtr = &opt.Groups
		}

		options = append(options, &model.ProviderOption{
			Name:       opt.Name,
			Help:       opt.Help,
			Required:   opt.Required,
			IsPassword: opt.IsPassword,
			Default:    defaultVal,
			Examples:   examples,
			Advanced:   opt.Advanced,
			Groups:     groupsPtr,
			Exclusive:  opt.Exclusive,
			Type:       opt.Type(),
		})
	}

	return &model.Provider{
		Name:        provider.Name,
		Description: provider.Description,
		Prefix:      provider.Name, // rclone uses name as prefix
		Options:     options,
	}, nil
}

// Provider is the resolver for the provider field.
func (r *queryResolver) Provider(ctx context.Context) (*model.ProviderQuery, error) {
	return &model.ProviderQuery{}, nil
}

// ProviderQuery returns generated.ProviderQueryResolver implementation.
func (r *Resolver) ProviderQuery() generated.ProviderQueryResolver { return &providerQueryResolver{r} }

type providerQueryResolver struct{ *Resolver }
