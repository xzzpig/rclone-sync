# Feature Specification: Rclone 连接配置数据库存储

**Feature Branch**: `004-rclone-config-db`  
**Created**: 2025-12-15  
**Status**: Draft  
**Input**: User description: "将 rclone 连接配置从配置文件改为存储到数据库中"

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 创建新的云存储连接 (Priority: P1)

用户希望添加一个新的云存储连接（如 OneDrive、Google Drive、S3 等），系统应将连接配置信息安全地存储在数据库中，而不是传统的 rclone.conf 配置文件中。

**Why this priority**: 这是系统的核心功能，用户必须能够创建连接才能使用同步功能。数据库存储可以提供更好的安全性、可管理性和一致性。

**Independent Test**: 可以通过创建一个新连接并验证其配置被正确存储在数据库中来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户在连接管理页面, **When** 用户选择云存储提供商并填写必要的配置信息, **Then** 系统将配置保存到数据库并显示成功消息
2. **Given** 用户已创建连接, **When** 用户刷新页面或重新登录, **Then** 之前创建的连接应该完整显示在连接列表中
3. **Given** 用户尝试创建连接, **When** 配置信息不完整或无效, **Then** 系统应显示清晰的错误提示而不保存无效数据

---

### User Story 2 - 查看和管理现有连接 (Priority: P1)

用户需要查看所有已配置的云存储连接列表，并能够查看每个连接的详细配置信息。

**Why this priority**: 用户必须能够看到自己的连接才能管理它们，这是基本的可用性需求。

**Independent Test**: 可以通过添加多个连接后查看列表和详情来验证功能完整性。

**Acceptance Scenarios**:

1. **Given** 用户有多个已配置的连接, **When** 用户访问连接管理页面, **Then** 所有连接应按名称排序显示在列表中
2. **Given** 用户查看连接列表, **When** 用户点击某个连接, **Then** 系统应显示该连接的配置详情（敏感信息如 token 应适当脱敏显示）

---

### User Story 3 - 更新连接配置 (Priority: P2)

用户需要能够修改现有连接的配置信息，如更新认证令牌或更改连接参数。

**Why this priority**: 配置可能需要更新（如令牌过期、更改设置），但这是在基本创建/查看功能之后的需求。

**Independent Test**: 可以通过修改连接的某个配置值并验证更改被正确保存来测试。

**Acceptance Scenarios**:

1. **Given** 用户有一个已配置的连接, **When** 用户修改配置并保存, **Then** 新配置应被持久化且连接功能正常
2. **Given** 用户修改配置, **When** 保存失败（如网络错误）, **Then** 原有配置应保持不变

---

### User Story 4 - 删除连接 (Priority: P2)

用户需要能够删除不再需要的云存储连接。

**Why this priority**: 清理不需要的连接是重要的管理功能，但优先级低于创建和查看。

**Independent Test**: 可以通过删除连接并验证其从数据库和列表中移除来测试。

**Acceptance Scenarios**:

1. **Given** 用户有一个已配置的连接, **When** 用户确认删除该连接, **Then** 连接应从数据库中永久删除
2. **Given** 连接被某个同步任务使用, **When** 用户尝试删除该连接, **Then** 系统应弹出警告并要求二次确认，但无需列出具体任务

---

### User Story 5 - 敏感信息安全存储 (Priority: P1)

系统必须确保连接配置中的敏感信息（如 OAuth 令牌、密钥、密码）在数据库中安全存储。

**Why this priority**: 安全性是核心需求，敏感凭证必须得到保护以防止泄露。

**Independent Test**: 可以通过直接查询数据库验证敏感字段是否被加密存储。

**Acceptance Scenarios**:

1. **Given** 连接配置包含 OAuth 令牌, **When** 数据被存储到数据库, **Then** 令牌应以加密形式存储
2. **Given** 敏感信息已加密存储, **When** 应用读取配置时, **Then** 系统应能正确解密并使用这些凭证

---

### User Story 6 - 令牌自动刷新与连接状态监控 (Priority: P2)

对于支持 OAuth 的云存储连接（如 OneDrive、Google Drive 等），系统依赖 rclone 内置的令牌刷新机制来自动刷新访问令牌。系统需要在连接失败时检测并向用户显示状态。

**Why this priority**: 令牌刷新是保证 OAuth 连接长期可用的关键功能，但由于依赖 rclone 内置机制，系统主要负责状态监控和错误显示。

**Independent Test**: 可以通过配置一个 OAuth 连接，执行同步操作时验证 rclone 是否自动处理令牌刷新，以及连接失败时是否正确显示错误状态。

**Acceptance Scenarios**:

1. **Given** 连接使用 OAuth 认证且令牌即将过期, **When** rclone 执行操作时, **Then** rclone 内置机制应自动刷新令牌并更新配置
2. **Given** rclone 刷新令牌成功, **When** 配置被更新后, **Then** 数据库中的令牌信息应被同步更新
3. **Given** 连接无法正常工作（如令牌已失效、网络问题等）, **When** 同步任务执行失败, **Then** 系统应在连接概览页面显示失败状态和错误原因

---

### User Story 7 - 从 rclone.conf 文件导入连接 (Priority: P2)

用户希望能够通过多步导入向导从现有的 rclone.conf 配置文件中导入连接配置，以便快速迁移已有的云存储连接到新系统中，或者从其他 rclone 工具导入配置。

**Why this priority**: 这是方便用户迁移和快速配置的重要功能，但用户也可以通过手动创建连接来实现相同目的。

**Independent Test**: 可以通过准备一个标准的 rclone.conf 文件，使用导入向导完成全流程，并验证所有连接都被正确创建来测试。

**多步导入向导流程**:

- **步骤 1 - 输入配置**: 用户将 rclone.conf 文件内容粘贴到多行文本输入框中，点击"下一步"
- **步骤 2 - 预览与编辑**: 系统验证、解析内容并测试连接，将结果展示为列表。用户可对列表中的每个连接进行编辑、测试或删除操作
- **步骤 3 - 确认导入**: 用户点击"导入"按钮，系统将列表中的连接批量导入到数据库

**Acceptance Scenarios**:

1. **Given** 用户进入导入向导, **When** 用户将 rclone.conf 内容粘贴到文本框并点击"下一步", **Then** 系统应验证、解析内容并进入预览步骤
2. **Given** 用户在预览步骤查看连接列表, **When** 系统完成解析, **Then** 每个连接应显示名称、类型、连接测试状态（成功/失败/待测试）
3. **Given** 用户在预览步骤, **When** 用户点击某个连接的"编辑"按钮, **Then** 系统应允许用户修改该连接的配置参数
4. **Given** 用户在预览步骤, **When** 用户点击某个连接的"测试"按钮, **Then** 系统应尝试连接该远程存储并显示测试结果
5. **Given** 用户在预览步骤, **When** 用户点击某个连接的"删除"按钮, **Then** 该连接应从导入列表中移除（不影响原配置）
6. **Given** 导入内容本身存在重复的连接名称, **When** 系统解析配置时, **Then** 系统应报错并提示用户修正
7. **Given** 导入的连接名称与数据库已有连接冲突, **When** 用户查看导入预览, **Then** 系统应明细标识哪些连接会覆盖现有连接
8. **Given** 用户确认导入列表无误, **When** 用户点击"导入"按钮, **Then** 所有列表中的连接应被创建/更新到数据库

---

### Edge Cases

- 当用户尝试创建与已存在连接同名的连接时，系统应如何处理？（确认：始终拒绝创建，并提示用户选择不同名称）
- 当数据库不可用时，系统应如何处理读取/写入连接配置的请求？（假设：显示友好错误消息并记录日志）
- 当连接配置的加密密钥丢失、更改或数据损坏导致解密失败时，如何处理？（确认：连接状态标记为“失败”，并在概览页显示原因，引导用户重新配置）
- 如果用户想导入现有的 rclone.conf 配置，应如何处理？（确认：用户需手动使用导入功能，系统不提供自动迁移）
- 当令牌刷新时遇到网络错误，系统应如何处理？（假设：记录错误并在下次检查时重试，连续失败后通知用户）
- 当多个同步任务同时使用同一连接时，如何处理并发的令牌刷新？（假设：使用锁机制确保只刷新一次）
- 当导入的 rclone.conf 文件格式不正确或损坏时，系统应如何处理？（假设：显示解析错误并拒绝导入）
- 当导入包含不支持的存储类型时，系统应如何处理？（假设：标记为不支持并跳过该连接）

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: 系统必须提供数据库表/实体来存储 rclone 连接配置信息
- **FR-002**: 系统必须支持创建新的云存储连接并将配置保存到数据库
- **FR-003**: 系统必须支持读取数据库中存储的连接配置
- **FR-004**: 系统必须支持更新现有连接的配置信息
- **FR-005**: 系统必须支持删除连接配置
- **FR-006**: 系统必须使用对称加密对敏感配置信息（如令牌、密码）进行加密存储，加密密钥从配置文件或环境变量获取
- **FR-007**: 系统必须保持与现有 rclone 库的兼容性（在执行同步时能正确使用存储在数据库中的配置）
- **FR-008**: 系统必须确保连接名称在整个系统中唯一（手动创建时拒绝重名）
- **FR-009**: 系统必须在删除连接时采用级联删除策略，自动删除所有关联的 Task、Job 和 JobLog，并在删除前显示警告要求用户确认
- **FR-010**: 系统必须依赖 rclone 内置的令牌刷新机制来自动刷新 OAuth 令牌
- **FR-011**: 系统必须能够在 rclone 刷新令牌后同步更新数据库中的配置信息
- **FR-012**: 系统必须在同步任务执行失败时检测连接状态并记录错误原因
- **FR-013**: 系统必须在连接概览页面显示连接状态（正常/失败）及失败原因
- **FR-014**: 系统必须支持解析 rclone.conf 格式的配置文件
- **FR-015**: 系统必须提供多步导入向导，包含输入配置、预览编辑、确认导入三个步骤
- **FR-016**: 系统必须在导入预览步骤提供连接测试功能，允许用户验证连接是否有效
- **FR-017**: 系统必须在导入预览步骤支持用户编辑和删除待导入的连接
- **FR-018**: 系统必须在导入时检测连接名称冲突：1）导入内容内部存在名称重复时报错拒绝；2）与数据库已有连接重复时，明细标识冲突项并在用户确认后批量覆盖
- **FR-019**: 系统必须在导入时验证连接配置的有效性并报告问题

### Key Entities _(include if feature involves data)_

- **Connection（连接）**: 表示一个云存储连接，包含以下字段：

  - `id`: UUID 唯一标识符
  - `name`: 连接名称（对应 rclone remote 名称，系统内唯一）
  - `type`: 提供商类型（如 onedrive、s3、local 等）
  - `encrypted_config`: AES-256-GCM 加密的完整配置 JSON（包含所有配置参数和令牌信息）
  - `created_at`: 创建时间
  - `updated_at`: 更新时间
  - `load_status`: 连接加载状态（从 rclone cache 获取，非数据库字段）
  - **关系**: 一个 Connection 可被多个 Task 使用（1:N）

- **Task（任务）**: 现有实体，需修改以关联 Connection：
  - `connection_id`: UUID 外键，指向 Connection.id（替换原有的 `remote_name` 字段）
  - **关系**: 每个 Task 属于一个 Connection（N:1）
  - **级联删除**: 当 Connection 被删除时，所有关联的 Task 及其 Job、JobLog 会被自动级联删除

**设计说明**:

1. 采用整体加密方案，所有配置参数（包括 OAuth 令牌、密码等敏感信息）都序列化为 JSON 后整体加密存储在 `encrypted_config` 字段中，无需识别和单独处理敏感字段
2. Task 通过 `connection_id` 外键与 Connection 建立强关联，确保数据完整性
3. 删除 Connection 时采用级联删除策略，自动清理所有依赖的任务和历史记录

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 用户可以在 30 秒内完成创建新的云存储连接
- **SC-002**: 系统支持所有当前 rclone 支持的存储类型（50+种提供商）
- **SC-003**: 连接配置读取延迟不影响用户体验（页面加载时间增加不超过 500 毫秒）
- **SC-004**: 敏感信息（令牌、密码）100%以加密形式存储
- **SC-005**: 用户可通过手动导入功能将 rclone.conf 配置迁移到数据库（应用尚未正式发布，无需自动迁移）
- **SC-006**: 系统在数据库故障恢复后能正常读取所有连接配置
- **SC-007**: rclone 内置令牌刷新机制正常工作，刷新后的配置能正确同步到数据库
- **SC-008**: 连接失败时用户能在概览页面立即看到失败状态和错误原因
- **SC-009**: 用户可以在 1 分钟内完成从 rclone.conf 文件导入 10 个以上的连接
- **SC-010**: 导入过程中 100%正确识别和处理名称冲突

## Assumptions

- 应用程序已使用 SQLite 数据库（基于现有代码结构中的 ent 框架）
- 加密密钥将通过应用配置或环境变量提供
- 用户界面已支持连接的创建和管理，本功能主要涉及后端存储层的改造
- 现有的同步任务通过连接名称引用连接，因此连接名称需保持稳定

## Clarifications

### Session 2025-12-15

- Q: 系统应使用哪种加密策略来保护敏感数据？ → A: 使用对称加密，密钥从配置文件/环境变量中获取
- Q: OAuth 令牌刷新检查频率应该是多少？ → A: 延迟到技术规划阶段讨论
- Q: 令牌刷新失败时的用户通知方式？ → A: 依赖 rclone 内置的令牌刷新机制（如 OneDrive、Google Drive 等 rclone 原生支持自动刷新）；对于连接失败的情况，应在应用无法连接到远程时在概览页面显示失败状态和错误原因
- Q: 现有 rclone.conf 配置的迁移策略？ → A: 完全手动迁移。应用尚未正式发布，无需自动迁移功能；用户需主动使用导入功能
- Q: 用户应该通过什么方式将 rclone.conf 文件提供给系统进行导入？ → A: 使用一个多行文本输入框，用户自行粘贴 rclone.conf 文件内容
- Q: 系统在导入时应如何处理可能加密的 rclone.conf 配置内容？ → A: 仅支持未加密的配置（用户需使用 `rclone config show` 导出明文配置后再粘贴）
- Q: 导入时如何处理连接名称冲突？ → A: 分两种情况：1）单次导入内容本身存在名称重复时，直接报错拒绝导入；2）与数据库中已存在的连接重复时，使用明细标识提示用户哪些连接会被覆盖，确认后批量覆盖
- Q: 导入体验应如何优化？ → A: 使用多步导入向导：步骤 1-粘贴 rclone.conf 内容；步骤 2-预览列表（支持编辑、测试、删除操作）；步骤 3-确认导入
- Q: 当用户手动创建一个与现有连接同名的连接时，系统应如何处理？ → A: 始终拒绝创建重名连接，强制用户选择一个唯一的名称。
- Q: 当解密失败（如密钥错误或数据损坏）时，系统应如何向用户展示连接状态？ → A: 连接状态标记为“失败”，并在概览页面显示具体原因。
- Q: 在导入向导的编辑步骤中，如果用户编辑后的名称与现有连接冲突，系统应如何处理？ → A: 立即显示错误，阻止用户保存编辑，直到他们提供一个唯一的名称。
- Q: 当 rclone 自动刷新 OAuth 令牌后，系统如何确保数据库中的令牌被同步更新？ → A: 延迟到技术规划阶段讨论。
- Q: 当删除一个被同步任务使用的连接时，系统应如何操作？ → A: 采用级联删除策略。删除前弹出警告提示用户此操作将同时删除所有关联的任务及其执行历史，要求用户确认。确认后自动删除 Connection 及所有关联的 Task、Job、JobLog。

### Session 2025-12-16

- Q: Task 应该通过什么方式关联 Connection？ → A: Task 通过 `connection_id` UUID 外键关联 Connection，替换原有的 `remote_name` 字段。这样可以建立强关联，确保数据完整性，同时允许 Connection.name 可以被修改而不影响关联的任务。

## Out of Scope

- 多用户/多租户支持（假设为单用户应用）
- 连接配置的导出功能（仅支持导入，不支持导出到 rclone.conf 格式）
- 与外部密钥管理服务的集成
- 加密的 rclone.conf 配置文件解密导入（用户需先使用 `rclone config show` 导出明文）
