# Implementation Plan: Versioned Database Migration

**Branch**: `005-versioned-migration` | **Date**: 2025-12-19 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-versioned-migration/spec.md`

## Summary

Upgrade the current auto-migration mechanism based on ent ORM to a versioned migration system. Use **Atlas CLI** to generate migration scripts from ent schema, and use **golang-migrate** to execute migrations during application startup. The system only supports new databases or databases already under versioned migration (incompatible legacy databases will trigger an error), and migration scripts will be embedded into the binary to support single-file distribution.

## Technical Context

**Language/Version**: Go 1.25  
**Primary Dependencies**: entgo.io/ent v0.14.5, ariga.io/atlas (indirect)  
**Storage**: SQLite with Ent ORM  
**Testing**: go test with testify  
**Target Platform**: Linux/macOS/Windows (Standalone deployment)
**Project Type**: web (Go backend + SolidJS frontend)  
**Performance Goals**: Migration checks should complete in <1s during application startup  
**Constraints**: Rollbacks are not supported; startup is blocked on failure; single-instance execution assumed  
**Scale/Scope**: 10-50 migration scripts, 4 schema entities  
**Migration Modes**: Support two migration modes - versioned migration (versioned, production default) and auto migration (auto, development/testing)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| III. Test-Driven Development | ✅ PASS | Unit and integration tests will be written for migration logic |
| V. Observability and Reliability | ✅ PASS | FR-013 requires detailed log output |
| IX. Internationalization | ✅ PASS | Migration errors will use English logs directly (no language context during startup phase) |
| Security Requirements | ✅ PASS | Migrations do not involve credential handling |

**Pre-Phase 0 Gate**: ✅ PASSED - No violations

## Project Structure

### Documentation (this feature)

```text
specs/005-versioned-migration/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (N/A - internal feature, no API contracts)
└── tasks.md             # Phase 2 output
```

### Source Code (repository root)

```text
# Web application structure
internal/
├── core/
│   ├── db/
│   │   ├── db.go              # Modified: Replace auto-migration with versioned migration
│   │   ├── migrations.go      # New: Migration execution logic
│   │   └── migrations/        # New: Embedded migration scripts directory
│   │       ├── embed.go       # New: Go embed configuration
│   │       └── *.sql          # Migration SQL files (generated by Atlas CLI)
│   └── ent/                   # Existing ent generated code
```

**Structure Decision**: Follow existing project structure, adding migration-related code under `internal/core/db`. Use Atlas CLI (added to flake.nix) for migration management; no custom CLI commands required.

## Constitution Check (Post-Design)

*Re-check after Phase 1 design completion.*

| Principle | Status | Notes |
|-----------|--------|-------|
| III. Test-Driven Development | ✅ PASS | research.md defines the testing strategy, quickstart.md includes test verification steps |
| V. Observability and Reliability | ✅ PASS | Use golang-migrate Logger interface to output detailed migration logs |
| IX. Internationalization | ✅ PASS | Migration errors will use English logs directly (no language context during startup phase) |
| Security Requirements | ✅ PASS | Migrations do not involve credential handling |

**Post-Design Gate**: ✅ PASSED - All designs comply with constitution requirements

## Complexity Tracking

> No violations to report.