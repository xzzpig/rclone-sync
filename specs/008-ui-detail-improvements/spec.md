# Feature Specification: UI Detail Improvements

**Feature Branch**: `008-ui-detail-improvements`  
**Created**: 2024-12-24  
**Status**: Draft  
**Input**: User description: "细节优化：日志数量限制、JOB进度展示总文件数和字节数、传输进度展示、Storage Usage配额信息展示"

## Clarifications

### Session 2024-12-24

- Q: 定时日志清理任务的默认执行周期是多少？ → A: 默认每小时执行一次，允许通过配置文件使用 cron 格式自定义执行周期
- Q: 当日志数量限制设置为 0 时的处理方式？ → A: 设置为 0 表示无限制（不清理日志）
- Q: 当用户降低日志数量限制时的清理时机？ → A: 等待下次定时清理任务执行时清理
- Q: 作业进度信息的 UI 展示位置？ → A: 在作业列表页面直接展示（每个作业行显示进度）
- Q: 日志数量限制的默认值是多少？ → A: 默认 1000 条
- Q: 正在传输的文件详情（文件名、单文件进度）展示位置？ → A: 在概览页面（Overview）列表展示该连接下所有的活跃传输任务及其详情
- Q: 存储配额（Storage Usage）信息的获取与刷新策略？ → A: 实时获取：每次进入概览页面时实时从云端调用接口获取最新配额信息
- Q: 日志清理任务的性能约束如何定义？ → A: 按连接逐个清理，不限总时间

### Session 2025-12-26

- Q: 日志级别配置值是否区分大小写？ → A: 不区分大小写（DEBUG、Debug、debug 都有效）

### Session 2025-12-27

- Q: 作业详情中删除数、错误数的具体展示位置？ → A: 作业列表页面表格展示删除数、错误数
- Q: 作业进行中时，删除数和错误数是否也需要在作业列表表格中实时更新显示？ → A: 是，实时更新：删除数、错误数在作业列表表格中实时更新显示，与现有的文件进度/字节进度一致通过 Subscription 推送
- Q: 当删除数或错误数为 0 时，表格中该列应如何显示？ → A: 显示数字 "0"，保持表格列的一致性和可读性
- Q: 当 rclone 返回 filesChecked > 0 但 filesTransferred = 0 且 bytesTransferred = 0 时，该作业是否视为"无活动"？ → A: 视为"无活动"并删除（filesChecked 不作为判断条件）
- Q: 删除作业时如何处理关联的日志记录？ → A: 数据库级联删除（已由 Ent ORM 实现）
- Q: 是否需要支持额外日志级别（trace、fatal）？ → A: 仅支持标准四级（debug、info、warn、error）
- Q: 日志级别匹配结果的缓存策略？ → A: 按需缓存（首次计算并缓存结果，后续直接查表，使用 sync.Map 实现无锁并发）
- Q: 日志名称匹配是否区分大小写？ → A: 区分大小写（Case-Sensitive），配置键必须与代码中定义的 Logger Name 完全一致
- Q: 针对 rclone 库产生的日志，是否需要支持其内部细分模块的独立级别控制？ → A: 否，目前仅支持将 "rclone" 作为一个整体进行级别控制

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看同步作业详细进度 (Priority: P1)

作为一个用户，我希望在同步作业执行时能够看到详细的进度信息，包括总文件数、已传输文件数、总字节数和已传输字节数，以便我能够准确了解同步的进展情况。

**Why this priority**: 这是用户在执行同步操作时最关心的核心信息，能够帮助用户判断同步是否正常进行以及预估完成时间。

**Independent Test**: 可以通过启动一个包含多个文件的同步任务，在作业执行过程中观察UI上的进度信息是否正确显示并实时更新来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户启动了一个同步作业, **When** 作业正在执行中, **Then** 用户可以在作业列表页面的对应作业行直接看到总文件数和已传输文件数的显示（如 "45/128 files"）
2. **Given** 用户启动了一个同步作业, **When** 作业正在执行中, **Then** 用户可以在作业列表页面看到总字节数和已传输字节数的显示（如 "256 MB / 1.2 GB"）
3. **Given** 作业进度信息正在显示, **When** 有新的文件传输完成, **Then** 显示的进度数字自动更新，无需手动刷新页面
4. **Given** 用户查看作业进度, **When** 进度信息可用, **Then** 应同时显示百分比进度条以提供直观的视觉反馈

---

### User Story 2 - 查看文件传输详情 (Priority: P1)

作为一个用户，我希望能够看到当前正在传输的具体文件信息和每个文件的传输进度，以便我能够了解哪些文件正在被处理以及单个大文件的传输状态。

**Why this priority**: 对于包含大文件的同步场景，用户需要知道单个文件的传输进度，而不仅仅是整体进度。

**Independent Test**: 可以通过启动一个包含大文件的同步任务，观察是否能看到当前正在传输的文件名和该文件的传输进度来独立测试。

**展示形式**: 文件传输详情应以**列表形式**展示，每个列表项代表一个正在传输的文件。

**列表项包含内容**:

| 字段 | 说明 | 示例 |
|------|------|------|
| 文件名称 | 正在传输的文件名（含路径） | `documents/report.pdf` |
| 文件大小 | 文件的总大小 | `128 MB` |
| 已传输大小 | 当前已传输的字节数 | `45 MB` |
| 传输进度 | 百分比形式的传输进度 | `35%` |
| 进度条 | 可视化的传输进度条 | ████░░░░░░ |

**Acceptance Scenarios**:

1. **Given** 用户正在查看一个执行中的作业, **When** 有文件正在传输, **Then** 用户可以在列表中看到当前正在传输的文件名称
2. **Given** 用户正在查看一个执行中的作业, **When** 有大文件正在传输, **Then** 用户可以在列表项中看到该文件的传输进度（包含已传输大小、文件大小、百分比和进度条）
3. **Given** 多个文件正在并发传输, **When** 用户查看传输详情, **Then** 列表中显示所有正在传输的文件，每个文件独立显示各自的传输进度
4. **Given** 一个文件传输完成, **When** 下一个文件开始传输, **Then** 列表自动更新：完成的文件从列表中移除，新文件添加到列表中
5. **Given** 用户查看传输列表, **When** 没有文件正在传输, **Then** 显示空状态提示（如 "暂无传输中的文件"）

---

### User Story 3 - 查看存储配额详情 (Priority: P2)

作为一个用户，我希望在 Storage Usage 卡片中能够看到更详细的配额信息，包括已用空间、总配额、可用空间、回收站空间、其他空间占用以及对象数量等，以便我能够更好地管理云存储空间。

**Why this priority**: 帮助用户在同步前了解目标存储是否有足够空间，避免同步失败。完整的配额信息还能帮助用户识别回收站是否占用过多空间等问题。

**Independent Test**: 可以通过查看任意一个连接的 Storage Usage 卡片，确认是否显示完整的配额信息（包括 Trashed、Other、Objects 等字段）来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户查看一个云存储连接的概览页面, **When** 该存储支持配额查询, **Then** 用户可以看到已用空间的具体数值（如 "45.2 GB used"）
2. **Given** 用户查看 Storage Usage 卡片, **When** 该存储有配额限制, **Then** 用户可以看到总配额（如 "100 GB total"）
3. **Given** 用户查看 Storage Usage 卡片, **When** 配额信息可用, **Then** 用户可以看到可用空间（如 "54.8 GB free"）
4. **Given** 用户查看 Storage Usage 卡片, **When** 回收站信息可用, **Then** 用户可以看到回收站占用空间（如 "2.5 GB trashed"）
5. **Given** 用户查看 Storage Usage 卡片, **When** 其他空间信息可用, **Then** 用户可以看到其他空间占用（如 "1.2 GB other" - 可能包括版本控制、元数据等）
6. **Given** 用户查看 Storage Usage 卡片, **When** 对象数量信息可用, **Then** 用户可以看到存储的对象/文件数量（如 "12,345 objects"）
7. **Given** 用户查看 Storage Usage 卡片, **When** 配额信息可用, **Then** 用户可以看到使用百分比的可视化展示（如进度条显示 45%）
8. **Given** 用户查看 Storage Usage 卡片, **When** 某个字段信息不可用, **Then** 该字段应隐藏或显示 "N/A"
9. **Given** 用户查看 Storage Usage 卡片, **When** 该存储完全不支持配额查询, **Then** 应显示适当的提示信息（如 "配额信息不可用"）

---

### User Story 5 - 概览页展示进行中的任务列表 (Priority: P1)

作为一个用户，我希望在连接的概览页面能够看到一个卡片，展示当前正在进行中的同步任务（Job）列表，以便我能够直观地了解该连接下有哪些作业正在运行，而不仅仅是看到文件传输的细节。

**Why this priority**: 用户在概览页只能看到文件同步详细进度，缺少对"正在运行哪些任务"的整体视图。增加进行中任务列表卡片可以让用户快速了解当前连接的活动状态，提供更直观的任务监控体验。

**Independent Test**: 可以通过启动一个或多个同步任务，然后查看概览页面是否显示进行中的任务卡片，并验证任务列表是否正确更新来独立测试。

**展示形式**: 进行中的任务应以**卡片形式**展示在概览页面，卡片内包含任务列表。**当没有进行中的任务时，卡片应隐藏**（而非显示空状态）。

**卡片内容**:

| 字段 | 说明 | 示例 |
|------|------|------|
| 任务名称 | 正在执行的同步任务名称 | `每日备份` |
| 作业状态 | 当前作业的运行状态 | `同步中` |
| 开始时间 | 作业开始执行的时间 | `10:30:45` |
| 文件进度 | 文件数进度（已传输/总文件数） | `45/128 files` |
| 字节进度 | 字节数进度（已传输/总大小） | `256 MB / 1.2 GB` |
| 进度条 | 以已传输字节数为基准的可视化进度条 | ████░░░░░░ 35% |

**Acceptance Scenarios**:

1. **Given** 用户查看连接的概览页面, **When** 该连接下有正在执行的作业, **Then** 用户可以看到一个"进行中的任务"卡片，列出所有正在运行的作业
2. **Given** 用户查看"进行中的任务"卡片, **When** 有多个任务正在同时执行, **Then** 卡片中以列表形式显示所有进行中的任务，每个任务显示名称、状态、文件进度、字节进度和进度条
3. **Given** 用户正在查看"进行中的任务"卡片, **When** 一个任务完成, **Then** 该任务自动从列表中移除，无需手动刷新页面
4. **Given** 用户正在查看"进行中的任务"卡片, **When** 新的任务开始执行, **Then** 新任务自动添加到列表中，无需手动刷新页面
5. **Given** 用户查看连接的概览页面, **When** 该连接下没有正在执行的作业, **Then** "进行中的任务"卡片隐藏不显示
6. **Given** 用户点击"进行中的任务"列表中的某个任务, **When** 点击事件触发, **Then** 用户跳转到日志界面（Log 页面），并自动筛选该任务的日志

---

### User Story 6 - 按名称层级设置日志级别 (Priority: P2)

作为一个管理员，我希望能够在配置文件中按日志名称分别设置日志级别，并支持按 `.` 拆分名称后按层级匹配，以便我能够对不同模块的日志输出进行精细化控制，方便问题排查和性能优化。

**Why this priority**: 当需要调试特定模块时，全局日志级别可能产生过多日志或遗漏关键信息。按模块层级设置日志级别可以在不影响其他模块的情况下，对目标模块进行详细日志输出。

**Independent Test**: 可以通过在配置文件中设置不同模块的日志级别（如 `core.db = debug`），然后观察该模块的日志输出是否符合配置的级别，而其他模块保持全局级别来独立测试。

**层级匹配规则** (匹配过程**区分大小写**):

| 日志名称 | 配置项 | 匹配优先级 | 说明 |
|----------|--------|------------|------|
| `core.db.query` | `core.db.query` | 1 (最高) | 精确匹配 |
| `core.db.query` | `core.db` | 2 | 匹配父级 |
| `core.db.query` | `core` | 3 | 匹配更高父级 |
| `core.db.query` | 全局 level | 4 (最低) | 使用默认全局级别 |

**配置示例**:

```toml
[log]
level = "info"                    # 全局日志级别

[log.levels]
"core.db" = "debug"               # core.db 及其子模块使用 debug 级别
"core.scheduler" = "warn"         # core.scheduler 及其子模块使用 warn 级别
"rclone" = "error"                # rclone 及其子模块使用 error 级别
```

**Acceptance Scenarios**:

1. **Given** 配置文件设置 `[log.levels] "core.db" = "debug"`, **When** 日志名称为 `core.db` 的日志器输出日志, **Then** 该日志器使用 debug 级别
2. **Given** 配置文件设置 `[log.levels] "core.db" = "debug"`, **When** 日志名称为 `core.db.query` 的日志器输出日志, **Then** 该日志器继承父级配置，使用 debug 级别
3. **Given** 配置文件设置 `[log.levels] "core.db" = "debug"` 且全局 `level = "info"`, **When** 日志名称为 `core.scheduler` 的日志器输出日志, **Then** 该日志器使用全局 info 级别
4. **Given** 配置文件同时设置 `"core.db" = "debug"` 和 `"core.db.query" = "error"`, **When** 日志名称为 `core.db.query` 的日志器输出日志, **Then** 该日志器优先使用精确匹配的 error 级别
5. **Given** 配置文件未设置任何 `[log.levels]`, **When** 任意日志器输出日志, **Then** 所有日志器使用全局 level 配置的级别
6. **Given** 配置文件设置 `"Core.DB" = "debug"`, **When** 日志名称为 `core.db` 的日志器输出日志, **Then** 该日志器使用全局级别（因大小写不匹配）

---

### User Story 4 - 日志数量限制管理 (Priority: P2)

作为一个管理员，我希望能够在配置文件中统一设置每个连接保留日志的最大数量，并通过定时任务自动清理超出限制的旧日志，以便控制存储空间使用和系统性能，同时不影响正常的日志写入性能。

**Why this priority**: 对于长期运行的系统，日志积累会占用大量存储空间并可能影响性能。按连接独立统计可以确保每个连接都有完整的日志历史。

**Independent Test**: 可以通过在配置文件中设置日志限制数量（如1000条），然后为某个连接生成超过限制数量的日志，等待定时清理任务执行后验证该连接的旧日志是否被自动清理来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户查看配置文件, **When** 需要设置日志限制, **Then** 用户可以在配置文件中统一配置日志最大数量（如 max_logs_per_connection = 1000）
2. **Given** 配置文件设置日志最大数量为1000条, **When** 定时清理任务执行且连接A的日志数量超过1000条, **Then** 连接A最旧的日志被删除以保持连接A的日志总数不超过1000条
3. **Given** 配置文件设置日志最大数量为1000条, **When** 连接A有1500条日志，连接B有800条日志, **Then** 定时清理任务只清理连接A的500条最旧日志，连接B不受影响
4. **Given** 日志数量限制生效, **When** 定时清理任务按计划执行, **Then** 系统采用FIFO策略删除每个连接超出限制的最旧日志
5. **Given** 用户修改了配置文件中的日志数量限制, **When** 下次定时清理任务执行, **Then** 新的限制将被应用到所有连接

---

### User Story 7 - 自动删除无活动的作业 (Priority: P2)

作为一个管理员，我希望能够在配置文件中启用一个选项，当作业（Job）结束时，如果该作业没有产生任何实际活动（如文件传输、检查等），则自动删除该作业记录，以便减少数据库中无意义的作业记录，保持作业历史的整洁。

**Why this priority**: 对于定时执行的同步任务，如果源和目标已经完全同步，每次执行都会产生一个"空"作业记录。这些无活动的作业记录会随着时间积累，占用数据库空间并降低作业历史的可读性。

**Independent Test**: 可以通过在配置文件中启用该选项，然后执行一个源和目标完全相同的同步任务，验证作业结束后该作业记录是否被自动删除来独立测试。

**"无活动"的定义**:
- 传输的文件数为 0（filesTransferred = 0）
- 传输的字节数为 0（bytesTransferred = 0）
- 删除的文件数为 0（filesDeleted = 0）
- 错误数为 0（errorCount = 0）
- 作业状态为成功完成（status = SUCCESS）
- 注：filesChecked 不作为判断条件，即使检查了文件但无传输也视为"无活动"

**Acceptance Scenarios**:

1. **Given** 配置文件设置 `auto_delete_empty_jobs = true`, **When** 一个同步作业完成且未产生任何文件传输活动（filesTransferred = 0 且 bytesTransferred = 0）, **Then** 该作业记录及其关联日志通过数据库级联删除自动移除
2. **Given** 配置文件设置 `auto_delete_empty_jobs = true`, **When** 一个同步作业完成且传输了至少一个文件, **Then** 该作业记录保留在数据库中
3. **Given** 配置文件设置 `auto_delete_empty_jobs = false`（默认值）, **When** 一个同步作业完成且未产生任何活动, **Then** 该作业记录仍然保留在数据库中
4. **Given** 配置文件设置 `auto_delete_empty_jobs = true`, **When** 一个同步作业失败（有错误）, **Then** 即使没有传输任何文件，该作业记录也保留在数据库中（便于排查问题）
5. **Given** 配置文件未设置 `auto_delete_empty_jobs`, **When** 任何作业完成, **Then** 所有作业记录均保留（等同于 `auto_delete_empty_jobs = false`）

---

### User Story 8 - JOB 记录并展示更多状态信息 (Priority: P1)

作为一个用户，我希望在查看同步作业时能够看到更详细的状态信息，包括删除的文件数和错误数，以便我能够更全面地了解同步作业的执行情况和问题。

**Why this priority**: 用户需要了解同步过程中不仅传输了多少文件，还需要知道删除了多少文件、发生了多少错误，这些信息对于排查问题和了解同步状态至关重要。

**Independent Test**: 可以通过执行一个同步任务（包含需要删除的文件或产生错误的场景），然后查看作业详情中是否正确显示删除数和错误数来独立测试。

**数据来源**: 所有数据通过 `accounting.StatsInfo` 获取：
- `GetDeletes()` - 获取删除文件数
- `GetErrors()` - 获取错误数

**展示内容**:

| 字段 | 说明 | 示例 |
|------|------|------|
| 删除数 | 同步过程中删除的文件数（表格列） | `15` |
| 错误数 | 同步过程中发生的错误数（表格列） | `3` |

**展示位置**:
- **删除数、错误数**: 在作业列表页面的表格中作为独立列展示

**Acceptance Scenarios**:

1. **Given** 用户查看一个已完成的同步作业, **When** 该作业在执行过程中删除了文件, **Then** 用户可以在作业列表表格的删除数列看到删除的文件数（如 "15"）
2. **Given** 用户查看一个已完成的同步作业, **When** 该作业在执行过程中发生了错误, **Then** 用户可以在作业列表表格的错误数列看到错误数（如 "3"）
3. **Given** 用户查看一个正在执行的同步作业, **When** 作业进行中, **Then** 删除数和错误数实时更新
4. **Given** 用户查看一个同步作业, **When** 该作业没有删除任何文件, **Then** 删除数列显示 "0"
5. **Given** 用户查看一个同步作业, **When** 该作业没有发生任何错误, **Then** 错误数列显示 "0"
6. **Given** 用户在作业列表页面查看作业, **When** 存在错误, **Then** 错误数应以醒目的方式（如红色徽章）显示，便于用户快速识别有问题的作业

---

### Edge Cases

- 当存储后端不支持配额查询时，Storage Usage 卡片应优雅降级显示
- 当同步作业包含0个文件时，进度显示应正确处理（显示 "0/0 files" 或适当的空状态）
- 当传输速度为0或连接中断时，进度更新应正确处理
- 当日志数量限制设置为0时，表示无限制（不清理日志）
- 当用户降低日志数量限制时，等待下次定时清理任务执行时清理（不立即触发）
- 日志清理任务按连接逐个清理，无总时间限制（避免复杂的分批逻辑）
- 当连接下没有任何正在执行的作业时，"进行中的任务"卡片应正确隐藏
- 当多个任务同时开始或结束时，任务列表应正确处理并发更新
- 当配置文件中 `[log.levels]` 为空或不存在时，所有日志器应使用全局级别
- 当日志名称为空字符串时，应使用全局级别
- 当配置了无效的日志级别值时，应使用全局级别并记录警告
- 当 `auto_delete_empty_jobs = true` 且作业失败时，即使无活动也应保留作业记录以便排查问题
- 当作业正在删除过程中发生错误时，应记录警告日志但不影响后续流程
- 当同步过程中没有删除任何文件时，删除数列显示 "0"
- 当同步过程中没有发生任何错误时，错误数列显示 "0"
- 当作业完成后，删除数和错误数应持久化到数据库并在 UI 中正确显示

## Requirements *(mandatory)*

### Functional Requirements

#### 作业进度展示

- **FR-001**: 系统必须在作业执行时展示总文件数和已传输文件数
- **FR-002**: 系统必须在作业执行时展示总字节数和已传输字节数
- **FR-003**: 系统必须以人类可读的格式展示字节数（如 KB, MB, GB）
- **FR-004**: 系统必须实时更新进度信息，无需用户手动刷新
- **FR-005**: 系统必须显示整体进度的百分比进度条

#### 传输进度详情

- **FR-006**: 系统必须显示当前正在传输的文件名称
- **FR-007**: 系统必须显示当前传输文件的传输进度（已传输大小/总大小）
- **FR-008**: 系统必须支持显示多个并发传输的文件状态
- **FR-009**: 系统必须实时更新当前传输文件列表

#### 存储配额展示

- **FR-010**: Storage Usage 卡片必须显示已用空间数值（Used）
- **FR-011**: Storage Usage 卡片必须显示总配额数值（Total，如果可用）
- **FR-012**: Storage Usage 卡片必须显示可用空间数值（Free）
- **FR-013**: Storage Usage 卡片必须显示回收站占用空间（Trashed，如果可用）
- **FR-014**: Storage Usage 卡片必须显示其他空间占用（Other，如果可用 - 如版本控制、元数据等）
- **FR-015**: Storage Usage 卡片必须显示对象/文件数量（Objects，如果可用）
- **FR-016**: Storage Usage 卡片必须显示使用百分比的可视化进度条
- **FR-017**: 当某个配额字段不可用时，该字段应隐藏或显示 "N/A"
- **FR-018**: 当存储完全不支持配额查询时，系统必须显示适当的提示信息

#### 日志管理

- **FR-019**: 系统必须允许用户在配置文件中统一设置每个连接的日志保留最大数量（设置为 0 表示无限制，默认 1000 条）
- **FR-020**: 日志数量必须按连接独立统计，每个连接最多保留配置的日志数量
- **FR-021**: 系统必须使用定时任务（而非实时）清理超出限制的日志
- **FR-022**: 定时清理任务执行时，必须遍历每个连接并删除超出限制的最旧日志
- **FR-023**: 日志清理策略必须采用FIFO（先进先出）原则
- **FR-024**: 日志数量限制配置必须存储在配置文件中
- **FR-025**: 定时清理任务的执行周期应可配置，默认每小时执行一次，支持 cron 格式配置

#### 进行中任务列表展示

- **FR-026**: 概览页面必须显示一个"进行中的任务"卡片，展示当前连接下所有正在执行的作业（Job）
- **FR-027**: 进行中任务卡片必须显示每个任务的名称、状态、文件进度（已传输/总文件数）、字节进度（已传输/总大小）和以已传输字节数为基准的进度条
- **FR-028**: 进行中任务列表必须实时更新，当作业开始或完成时自动添加或移除
- **FR-029**: 当没有进行中的任务时，整个卡片必须隐藏（而非显示空状态）
- **FR-030**: 进行中任务列表应显示每个作业的开始时间
- **FR-031**: 用户点击任务列表中的某个任务时，必须跳转到日志界面（Log 页面）并自动筛选该任务的日志

#### 层级日志级别配置

- **FR-032**: 系统必须支持在配置文件中按日志名称分别设置日志级别
- **FR-033**: 日志名称必须按 `.` 拆分后按层级匹配，优先匹配精确名称，再按层级向上匹配父级
- **FR-034**: 当日志名称未匹配到任何配置项时，必须使用全局日志级别作为默认值
- **FR-035**: 配置项必须支持 `debug`, `info`, `warn`, `error` 四个日志级别（不区分大小写）
- **FR-036**: 日志级别配置变更后，必须在应用重启后生效（无需支持热更新）
- **FR-037**: 日志级别匹配结果必须采用按需缓存策略（首次计算后缓存，后续直接查表），使用 `sync.Map` 实现无锁并发访问

#### 自动删除无活动作业

- **FR-038**: 系统必须允许用户在配置文件中设置 `auto_delete_empty_jobs` 选项（布尔值，默认 true）
- **FR-039**: 当 `auto_delete_empty_jobs = true` 时，作业结束后如果未产生任何实际活动，系统必须自动删除该作业记录
- **FR-040**: "无活动"的判定标准为：传输文件数为 0、传输字节数为 0、且作业状态为成功完成
- **FR-041**: 当作业失败（有错误）时，即使无活动也必须保留作业记录
- **FR-042**: 删除作业时必须同时删除该作业关联的所有日志记录

#### 作业状态信息展示

- **FR-043**: 系统必须在作业执行时实时展示删除的文件数（通过 `accounting.StatsInfo.GetDeletes()` 获取）
- **FR-044**: 系统必须在作业执行时实时展示错误数（通过 `accounting.StatsInfo.GetErrors()` 获取）
- **FR-045**: 作业完成后，删除数和错误数必须持久化到数据库
- **FR-046**: 当存在错误时，错误数应以醒目的方式（如红色徽章）显示，便于用户快速识别有问题的作业

### Key Entities

- **Job Progress**: 表示作业的进度状态，包含以下字段：
  - filesTotal: 总文件数
  - filesTransferred: 已传输文件数
  - bytesTotal: 总字节数
  - bytesTransferred: 已传输字节数
  - filesDeleted: 删除的文件数（通过 `accounting.StatsInfo.GetDeletes()` 获取）
  - errorCount: 错误数（通过 `accounting.StatsInfo.GetErrors()` 获取）
- **Transfer Item**: 表示当前正在传输的单个文件项，包含文件名、文件大小、已传输大小
- **Storage Quota**: 表示存储配额信息，包含以下字段：
  - Total: 总配额
  - Used: 已用空间
  - Free: 可用空间
  - Trashed: 回收站占用空间
  - Other: 其他空间占用（版本控制、元数据等）
  - Objects: 对象/文件数量
- **Log Configuration**: 表示日志配置，包含以下属性：
  - 最大日志数量限制（在配置文件中统一配置，适用于所有连接，默认 1000 条，设置为 0 表示无限制）
  - 定时清理任务的执行周期配置（cron 格式，默认 `0 * * * *` 即每小时执行一次）
  - 注：日志数量按连接独立统计，每个连接最多保留配置的日志数量
- **Log Level Configuration**: 表示层级日志级别配置，包含以下属性：
  - 全局日志级别（`level`，默认 `info`）
  - 按名称设置的日志级别映射（`levels`，key 为日志名称，value 为日志级别）
  - 层级匹配规则：按 `.` 拆分名称后，优先精确匹配，再按层级向上匹配父级，最后使用全局级别
- **Job Auto-Delete Configuration**: 表示作业自动删除配置，包含以下属性：
  - 自动删除无活动作业（`auto_delete_empty_jobs`，布尔值，默认 `false`）

## Assumptions

- rclone 的同步进度回调能够提供文件级别和字节级别的进度信息
- rclone 的 about 命令能够提供存储配额信息（对于支持的存储后端）
- 前端使用 GraphQL Subscription 接收实时进度更新
- 日志存储在数据库中，可以按连接进行数量查询和批量删除
- 系统已有定时任务调度机制（如 cron scheduler）可以复用

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在作业执行时看到文件级别进度（x/y files）和字节级别进度（xx MB / yy GB）
- **SC-002**: 进度信息更新延迟不超过2秒
- **SC-003**: 用户能够看到当前正在传输的文件及其传输进度
- **SC-004**: Storage Usage 卡片显示完整的配额信息，包括 Total、Used、Free、Trashed、Other、Objects 六个字段（根据后端支持情况）
- **SC-005**: 用户能够在配置文件中统一配置日志保留数量，系统按连接独立统计和清理
- **SC-006**: 系统通过定时任务按连接独立清理超出限制的旧日志
- **SC-007**: 所有新增的UI元素支持国际化
- **SC-008**: 概览页面展示"进行中的任务"卡片，用户能够直观看到当前连接下正在执行的作业列表
- **SC-009**: 进行中任务列表实时更新，任务开始/完成时列表自动添加/移除，更新延迟不超过2秒
- **SC-010**: 用户能够在配置文件中按日志名称层级设置不同的日志级别
- **SC-011**: 日志名称按 `.` 拆分后按层级匹配配置项，精确匹配优先于父级匹配
- **SC-012**: 当启用 `auto_delete_empty_jobs` 时，无活动的成功作业自动被删除，数据库中不保留此类作业记录
- **SC-013**: 失败的作业即使无活动也保留在数据库中，便于问题排查
- **SC-014**: 用户能够在作业执行时和完成后看到删除的文件数（filesDeleted）
- **SC-015**: 用户能够在作业执行时和完成后看到错误数（errorCount），且存在错误时以醒目方式显示
