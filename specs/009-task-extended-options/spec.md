# Feature Specification: Task 扩展选项配置

**Feature Branch**: `009-task-extended-options`  
**Created**: 2025-12-28  
**Status**: Draft  
**Input**: User description: "Task 扩展选项配置：用户可以为同步任务配置过滤器规则、保留删除文件选项和并行传输数量"

## Clarifications

### Session 2025-12-28

- Q: 预览数据源：预览过滤后的文件时应该显示哪端的文件列表？ → A: 同时显示两端（源端和目标端），通过 Tab 切换
- Q: 预览加载策略：文件数量较多时如何加载和展示？ → A: 懒加载，仅加载当前展开的目录内容，用户展开子目录时再加载
- Q: 被过滤文件的展示方式：被排除的文件如何展示？ → A: 仅显示过滤后会被同步的文件（隐藏被排除的文件）
- Q: 预览刷新机制：规则修改后预览如何更新？ → A: 自动刷新（带防抖延迟）
- Q: 预览错误处理：预览无法加载时如何处理？ → A: 在预览区域内显示错误信息和重试按钮，不打断用户操作
- Q: 防抖延迟时间：过滤器规则修改后的预览自动刷新防抖延迟应设置为多长时间？ → A: 500ms（标准表单防抖）

## User Scenarios & Testing *(mandatory)*

**UI 布局**:
- **任务设置页面**: 包含基本设置（名称、路径、同步方向等）以及 "保留删除文件"、"并行传输数量" 选项
- **过滤器 Tab**: 单独的标签页，用于配置文件过滤规则

### User Story 1 - 过滤器配置 (Priority: P1)

用户在创建或编辑同步任务时，可以配置文件过滤规则来控制哪些文件应该被同步、哪些应该被排除。用户通过可视化规则列表界面配置过滤器，每条规则包含类型（包含/排除）和模式。

**Why this priority**: 过滤器功能是最常用的高级选项，可以避免同步不必要的文件（如临时文件、编译产物、node_modules 等），显著提高同步效率并节省存储空间。

**Independent Test**: 创建一个任务并配置过滤器规则（如排除 `node_modules/**`），然后执行同步，验证被排除的文件不会被同步到目标端。

**UI 布局**:
- 过滤器配置位于任务设置页面的独立 "过滤器" Tab 标签页
- 采用可视化规则列表形式展示

**示例 UI 布局**:
```
┌─────────────────────────────────────────────────────────┐
│ 过滤规则                                        [+ 添加] │
├─────────────────────────────────────────────────────────┤
│ [Exclude ▼] [node_modules/**        ] [↑] [↓] [🗑️]     │
│ [Exclude ▼] [.git/**                ] [↑] [↓] [🗑️]     │
│ [Exclude ▼] [*.tmp                  ] [↑] [↓] [🗑️]     │
│ [Include ▼] [**                     ] [↑] [↓] [🗑️]     │
└─────────────────────────────────────────────────────────┘
│ ℹ️ 规则按从上到下顺序匹配，第一个匹配的规则生效          │
│ 📖 查看 rclone filter 语法文档                          │
└─────────────────────────────────────────────────────────┘

▶ 预览过滤后的文件                       ← 默认折叠，点击展开

点击展开后（此时才发起查询）：

▼ 预览过滤后的文件
┌─────────────────────────────────────────────────────────┐
│ [源端] [目标端]                        ← Tab 切换两端   │
├─────────────────────────────────────────────────────────┤
│ [FileBrowser - 仅显示过滤后会被同步的文件/目录]         │
│ 📁 photos/                              ← 懒加载展开    │
│   ├── 📄 image1.jpg                                     │
│   ├── 📄 image2.png                                     │
│   └── 📁 vacation/                      ← 点击加载子目录│
│       └── 📄 beach.jpg                                  │
├─────────────────────────────────────────────────────────┤
│ ℹ️ 规则修改后自动刷新（500ms 防抖延迟）                  │
└─────────────────────────────────────────────────────────┘

预览加载失败时：
┌─────────────────────────────────────────────────────────┐
│ ⚠️ 无法加载预览：连接失败                               │
│ [重试]                                                  │
└─────────────────────────────────────────────────────────┘
```

**底层存储**: 使用完整的 rclone filter 语法存储在数据库中。

**Acceptance Scenarios**:

1. **Given** 用户创建或编辑一个同步任务, **When** 进入任务设置页面, **Then** 用户可以看到 "过滤器" Tab 标签
2. **Given** 用户点击 "过滤器" Tab, **When** 进入过滤器配置页面, **Then** 用户可以看到过滤规则列表区域
3. **Given** 用户点击 "添加" 按钮, **When** 添加一条新规则, **Then** 列表末尾出现新的一行，包含类型下拉框和模式输入框
4. **Given** 用户在规则行中选择 "Exclude" 并输入 `node_modules/**`, **When** 保存任务, **Then** 系统将规则转换为 rclone filter 语法 `- node_modules/**` 并存储
5. **Given** 用户点击某条规则的上移/下移按钮, **When** 操作完成, **Then** 规则顺序发生变化，优先级随之调整
6. **Given** 用户点击某条规则的删除按钮, **When** 确认删除, **Then** 该规则从列表中移除
7. **Given** 用户配置了过滤器规则, **When** 执行同步任务, **Then** 系统按照规则过滤文件，被排除的文件不会被同步
8. **Given** 用户未配置任何过滤器规则, **When** 执行同步任务, **Then** 所有文件都会被同步（默认行为）
9. **Given** 用户输入了无效的模式（如空字符串）, **When** 保存任务, **Then** 系统应显示验证错误，阻止保存
10. **Given** 用户展开 "预览过滤后的文件" 区域, **When** 预览加载完成, **Then** 用户可以看到源端和目标端的 Tab 切换，默认显示源端过滤后的文件
11. **Given** 用户在预览区域点击目标端 Tab, **When** Tab 切换完成, **Then** 显示目标端过滤后的文件列表
12. **Given** 用户在预览中点击某个目录, **When** 目录展开, **Then** 系统按需加载该目录下的过滤后文件（懒加载）
13. **Given** 用户修改了过滤器规则, **When** 规则修改完成后（500ms 防抖延迟后）, **Then** 预览内容自动刷新
14. **Given** 预览加载失败（如连接失败、权限不足）, **When** 错误发生, **Then** 在预览区域内显示错误信息和重试按钮，不弹出对话框

**验证时机说明**: 过滤器规则仅在保存任务时进行校验（不进行实时校验）。用户可通过"预览过滤后的文件"功能在保存前发现规则问题。

---

### User Story 2 - 保留删除文件 (Priority: P2)

用户在创建或编辑单向同步任务时，可以选择启用 "保留删除文件" 选项。启用后，同步过程中只会同步新增和修改的文件，不会删除目标端的多余文件。

**Why this priority**: 保留删除文件是一个重要的数据保护功能，可以防止意外删除目标端的重要文件，特别适合备份场景。

**Independent Test**: 创建一个单向同步任务并启用 "保留删除文件" 选项，在源端删除一个文件后执行同步，验证目标端对应的文件不会被删除。

**适用范围**: 仅在单向同步模式（Upload/Download）下有效。双向同步（Bidirectional）模式下该选项不可用（UI 隐藏）。

**配置方式**: 任务设置页面中的一个开关选项（默认关闭）。

**后端处理**: 当后端收到双向同步任务且 `noDelete=true` 时，静默忽略该配置，正常执行双向同步（因为前端已隐藏该选项，正常情况下不会出现此组合）。

**Acceptance Scenarios**:

1. **Given** 用户创建或编辑一个单向同步任务, **When** 进入任务设置页面, **Then** 用户可以看到 "保留删除文件" 开关选项
2. **Given** 用户创建或编辑一个双向同步任务（Bidirectional）, **When** 进入任务设置页面, **Then** "保留删除文件" 选项应被隐藏，不展示给用户
3. **Given** 用户启用 "保留删除文件" 选项, **When** 源端删除了一个文件后执行单向同步, **Then** 目标端对应的文件不会被删除
4. **Given** 用户启用 "保留删除文件" 选项, **When** 源端新增或修改了文件后执行单向同步, **Then** 目标端正常同步新增和修改的文件
5. **Given** 用户禁用 "保留删除文件" 选项（默认）, **When** 源端删除了一个文件后执行单向同步, **Then** 目标端对应的文件会被删除（正常同步行为）
6. **Given** 用户查看任务详情, **When** 该任务启用了 "保留删除文件", **Then** 用户可以在任务信息中看到该选项的状态

---

### User Story 3 - 并行传输数量 (Priority: P2)

用户在创建或编辑同步任务时，可以配置同步时的并发传输数量，控制同步速度和资源占用。

**Why this priority**: 并行传输数量允许用户根据网络条件和系统资源优化同步性能，对于大量小文件的同步场景尤其重要。

**Independent Test**: 创建一个任务并配置并行传输数量为 8，执行同步时观察是否同时传输多个文件。

**配置方式**: 
- 全局默认值在配置文件中设置（默认 4）
- 每个任务可单独覆盖全局默认值
- 允许范围：1-64

**配置文件示例**:
```toml
[sync]
transfers = 4  # 全局默认并行传输数量
```

**Acceptance Scenarios**:

1. **Given** 用户创建或编辑一个同步任务, **When** 进入任务设置页面, **Then** 用户可以看到 "并行传输数量" 配置项
2. **Given** 用户设置并行传输数量为 8, **When** 执行同步任务, **Then** 系统最多同时传输 8 个文件
3. **Given** 用户未设置任务的并行传输数量, **When** 执行同步任务, **Then** 系统使用配置文件中的全局默认值
4. **Given** 配置文件未设置全局默认值, **When** 执行同步任务, **Then** 系统使用内置默认值 4
5. **Given** 用户尝试设置并行传输数量为 0 或负数, **When** 保存任务, **Then** 系统应显示验证错误，提示有效范围为 1-64
6. **Given** 用户尝试设置并行传输数量为 100, **When** 保存任务, **Then** 系统应显示验证错误，提示有效范围为 1-64
7. **Given** 用户查看任务详情, **When** 该任务设置了自定义并行传输数量, **Then** 用户可以在任务信息中看到该配置值

---

### Edge Cases

- 当过滤器规则为空时，应同步所有文件（默认行为）
- 当过滤器规则的模式为空字符串时，应阻止任务保存并显示错误提示
- 当过滤器规则相互矛盾时（如同时 include 和 exclude 同一文件），应按规则列表顺序处理（第一个匹配的规则生效）
- 当 "保留删除文件" 选项在双向同步模式下时，UI 应隐藏该选项，后端应忽略该配置
- 当并行传输数量设置为边界值（1 或 64）时，系统应正常工作
- 当任务未设置并行传输数量且配置文件也未设置时，应使用内置默认值 4
- 当过滤器包含特殊字符（如中文、空格）时，应原样传递给 rclone 引擎处理（rclone 原生支持 Unicode 和空格）
- 当过滤器配置在任务运行过程中被修改时，新配置不立即影响运行中的任务，仅对后续执行的任务生效
- 当预览请求失败时（网络超时、连接失败、权限不足、服务器错误 5xx 等），应在预览区域内显示错误信息和重试按钮，不进行自动重试（避免频繁请求）
- 当预览的目录层级很深时，应按需加载（懒加载），避免一次性加载过多数据

## Requirements *(mandatory)*

### Functional Requirements

#### 过滤器配置

- **FR-001**: 系统必须支持为每个任务配置文件过滤器（filter），使用 rclone filter 语法
- **FR-002**: 过滤器配置界面必须以可视化规则列表形式展示，每条规则一行
- **FR-003**: 每条规则必须包含类型选择（Include/Exclude）和模式输入框
- **FR-004**: 过滤器配置界面必须支持添加、删除、上移、下移规则的操作
- **FR-005**: 过滤器配置界面必须提供 rclone filter 语法文档链接
- **FR-006**: 系统必须在保存任务前验证过滤器模式，空模式时阻止保存并显示错误提示
- **FR-007**: 系统必须支持过滤器规则预览功能，同时支持源端和目标端的文件列表预览（通过 Tab 切换）
- **FR-007a**: 预览功能必须采用懒加载策略，仅加载当前展开的目录内容
- **FR-007b**: 预览仅显示过滤后会被同步的文件，隐藏被排除的文件
- **FR-007c**: 过滤器规则修改后，预览必须自动刷新（防抖延迟 500ms，避免频繁请求）
- **FR-007d**: 预览加载失败时，必须在预览区域内显示错误信息和重试按钮，不打断用户操作
- **FR-008**: 系统必须在任务执行时将过滤器规则传递给 rclone 引擎

#### 保留删除文件

- **FR-009**: 系统必须支持为每个单向同步任务（Upload/Download）配置 "保留删除文件" 选项（布尔值，默认 false）
- **FR-010**: 当任务为双向同步模式时，UI 必须隐藏 "保留删除文件" 选项
- **FR-011**: 当 "保留删除文件" 启用时，单向同步过程中不得删除目标端的任何文件

#### 并行传输数量

- **FR-012**: 系统必须支持为每个任务配置并行传输数量（整数，范围 1-64）
- **FR-013**: 系统必须支持在配置文件中设置并行传输数量的全局默认值（默认 4）
- **FR-014**: 当任务未设置并行传输数量时，必须使用全局默认值；当全局默认值未设置时，使用内置默认值 4

#### 通用

- **FR-015**: 系统必须在任务详情和列表中展示已配置的高级选项状态

### Key Entities

- **Task Extended Options**: 表示任务扩展选项，扩展现有 TaskSyncOptions，包含以下属性：
  - `filters`: 文件过滤器规则列表（字符串数组，rclone filter 语法，每个元素格式为 "- pattern" 或 "+ pattern"）
  - `noDelete`: 保留删除文件（布尔值，默认 `false`）
  - `transfers`: 并行传输数量（整数，范围 1-64，可为空表示使用全局默认值）

- **Sync Configuration**: 表示同步相关的全局配置，包含以下属性：
  - `transfers`: 并行传输数量的全局默认值（整数，默认 4，范围 1-64）

## Assumptions

- rclone 的 filter 参数能够正确解析和应用过滤规则
- rclone 的 `--no-traverse` 和 `--delete-excluded` 等参数能够配合过滤器正确工作
- rclone 的 `--transfers` 参数能够控制并发传输数量
- 程序将 rclone 作为库依赖，固定 rclone 版本，需要编写单元测试来验证过滤语法支持情况
- 前端使用现有的任务设置页面架构，添加新的 Tab 和配置项
- 预览刷新防抖延迟固定为 500ms，这是标准表单防抖时间，在用户输入体验和后端请求频率之间取得平衡
- 用户可以通过修改 config.toml 文件中的 `[sync]` 部分的 `transfers` 字段来覆盖全局默认并行传输数量（配置格式：`[sync]\ntransfers = 4`）
- 并行传输数量的优先级顺序：任务级配置 > 全局配置（config.toml） > 内置默认值（4）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在任务设置中通过可视化规则列表配置文件过滤器，支持添加/删除/排序规则
- **SC-002**: 配置了过滤器的任务执行时，被排除的文件不会被同步
- **SC-003**: 用户能够在单向同步任务设置中启用 "保留删除文件" 选项，启用后同步不会删除目标端文件；双向同步模式下该选项不可用
- **SC-004**: 用户能够在任务设置中配置并行传输数量，范围为 1-64
- **SC-005**: 未配置并行传输数量的任务使用配置文件中的全局默认值（默认 4）
- **SC-006**: 任务详情页面正确展示已配置的扩展选项状态
